<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>three-vrm example</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <!-- 初期モーダル -->
    <div id="start-modal" class="modal active">
        <div class="modal-content">
            <h1>@nifty光 契約受付</h1>
            <button id="startButton">ご案内開始</button>
        </div>
    </div>
    <!-- YouTube再生モーダル -->
    <div id="yt-modal" class="modal">
        <div class="modal-content yt">
            <div class="yt-frame">
                <div id="yt-player"></div>
            </div>
            <div id="yt-error" class="yt-error" hidden></div>
        </div>
    </div>
    <div id="stage-wrap">
        <div id="app">
            <!-- canvas は main.js が append -->
            <div id="ui">
                <div id="stage" style="width:768px; height:1024px;">
                    <!-- Page 1 -->
                    <section class="page active" id="page1">
                        <div class="balloon">
                            <p>
                                @nifty光のお申込みありがとうございます。<br>
                                まずは@niftyからのご契約前の重要事項の説明を動画でご案内します。<br>
                                「視聴開始」を押してください。
                            </p>
                        </div>
                        <div class="page-bottom right">
                            <button class="btn next" data-next="page2" data-youtube="6FRlR3EwpYM">視聴開始</button>
                        </div>
                    </section>

                    <!-- Page 2 -->
                    <section class="page" id="page2" aria-hidden="true">
                        <div class="balloon">
                            <p>
                                動画のご視聴ありがとうございます。<br>
                                従業員がノジマのアプリ会員情報からお客様情報を反映させました。<br>
                                誤りがなければ「次へ」を押してください。
                            </p>
                        </div>
                        <!-- 例: 顧客情報カード -->
                        <div class="card">
                            <ul class="form-like form-like--sheet">

                                <!-- お申込者名（カナ） -->
                                <li class="row">
                                    <div class="row-label">
                                        <span class="badge">お申込者名（カナ）</span>
                                    </div>

                                    <div class="row-body row-two">
                                        <label class="mini">姓</label>
                                        <input class="pill-input" id="nameKanaFamily" name="nameKanaFamily" type="text"
                                            inputmode="kana" value="ミホン" readonly />
                                        <label class="mini">名</label>
                                        <input class="pill-input" id="nameKanaGiven" name="nameKanaGiven" type="text"
                                            inputmode="kana" value="タロウ" readonly />
                                    </div>

                                    <div class="row-ctrl">
                                        <button class="fix-btn" type="button">修正</button>
                                    </div>
                                </li>

                                <!-- お申込者名（漢字） -->
                                <li class="row">
                                    <div class="row-label">
                                        <span class="badge">お申込者名（漢字）</span>
                                    </div>

                                    <div class="row-body row-two">
                                        <label class="mini">姓</label>
                                        <input class="pill-input" id="nameKanjiFamily" name="nameKanjiFamily"
                                            type="text" value="見本" readonly />
                                        <label class="mini">名</label>
                                        <input class="pill-input" id="nameKanjiGiven" name="nameKanjiGiven" type="text"
                                            value="太郎" readonly />
                                    </div>

                                    <div class="row-ctrl">
                                        <button class="fix-btn" type="button">修正</button>
                                    </div>
                                </li>

                                <!-- 性別（表示ピル） -->
                                <li class="row">
                                    <div class="row-label">
                                        <span class="badge">性別</span>
                                    </div>

                                    <div class="row-body">
                                        <div class="pill-display">男性</div>
                                    </div>

                                    <div class="row-ctrl">
                                        <button class="fix-btn" type="button">修正</button>
                                    </div>
                                </li>

                                <!-- 生年月日（3分割 + 年月日ラベル） -->
                                <li class="row">
                                    <div class="row-label">
                                        <span class="badge">生年月日</span>
                                    </div>

                                    <div class="row-body row-date">
                                        <input class="pill-input center" type="text" inputmode="numeric" pattern="\d*"
                                            maxlength="4" value="1982" readonly />
                                        <span class="unit">年</span>
                                        <input class="pill-input center" type="text" inputmode="numeric" pattern="\d*"
                                            maxlength="2" value="6" readonly />
                                        <span class="unit">月</span>
                                        <input class="pill-input center" type="text" inputmode="numeric" pattern="\d*"
                                            maxlength="2" value="23" readonly />
                                        <span class="unit">日</span>
                                    </div>

                                    <div class="row-ctrl">
                                        <button class="fix-btn" type="button">修正</button>
                                    </div>
                                </li>

                                <!-- 電話番号（3分割 + 罫線風ハイフン） -->
                                <li class="row">
                                    <div class="row-label">
                                        <span class="badge">電話番号</span>
                                    </div>

                                    <div class="row-body row-tel">
                                        <input class="pill-input center" type="text" inputmode="numeric" pattern="\d*"
                                            maxlength="4" value="080" readonly />
                                        <span class="sep">—</span>
                                        <input class="pill-input center" type="text" inputmode="numeric" pattern="\d*"
                                            maxlength="4" value="1234" readonly />
                                        <span class="sep">—</span>
                                        <input class="pill-input center" type="text" inputmode="numeric" pattern="\d*"
                                            maxlength="4" value="5678" readonly />
                                    </div>

                                    <div class="row-ctrl">
                                        <button class="fix-btn" type="button">修正</button>
                                    </div>
                                </li>

                            </ul>
                        </div>

                        <div class="page-bottom">
                            <button class="btn back" data-prev="page1">戻る</button>
                            <button class="btn next" data-next="page3">次へ</button>
                        </div>
                    </section>

                    <!-- Page 3 -->
                    <section class="page" id="page3" aria-hidden="true">
                        <div class="balloon">
                            <p>
                                お客様情報から現在ご利用中の@nifty IDが見つかりました。<br>
                                今回ご利用になるIDを選んでください。
                            </p>
                        </div>

                        <!-- 例: 顧客情報カード -->
                        <div class="card">
                            <!-- 1件目 -->
                            <div class="idcard-row">
                                <label class="idcard">
                                    <input type="radio" name="niftyId" value="RKT39256-1" checked>
                                    <div class="idcard__body">
                                        <div class="idcard__radio"></div>
                                        <div class="idcard__main">
                                            <div class="idcard__title">RKT39256</div>
                                            <div class="idcard__meta">
                                                <div>@nifty IDメールアドレス</div>
                                                <div class="idcard__meta-value">example@nifty.com</div>
                                                <div>ご入会日</div>
                                                <div class="idcard__meta-value">2023年4月12日</div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                <div class="idcard__side">
                                    <div class="plan">
                                        <div class="plan__title">月額課金</div>
                                        <div class="plan__value plan__value--none">なし</div>
                                        <button type="button" class="plan__detail">詳細</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 2件目 -->
                            <div class="idcard-row">
                                <label class="idcard">
                                    <input type="radio" name="niftyId" value="RKT39256-2">
                                    <div class="idcard__body">
                                        <div class="idcard__radio"></div>
                                        <div class="idcard__main">
                                            <div class="idcard__title">NOS39256</div>
                                            <div class="idcard__meta">
                                                <div>@nifty IDメールアドレス</div>
                                                <div class="idcard__meta-value">example@nifty.com</div>
                                                <div>ご入会日</div>
                                                <div class="idcard__meta-value">2023年6月20日</div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                <div class="idcard__side">
                                    <div class="plan">
                                        <div class="plan__title">月額課金</div>
                                        <div class="plan__value plan__value--has">あり</div>
                                        <button type="button" class="plan__detail">詳細</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 新規登録 -->
                            <div class="idcard-row">
                                <label class="idcard idcard--new">
                                    <input type="radio" name="niftyId" value="__new__">
                                    <div class="idcard__body">
                                        <div class="idcard__radio"></div>
                                        <div class="idcard__main">
                                            <div class="idcard__title idcard__title--new">@nifty IDを新規登録する</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="page-bottom">
                            <button class="btn back" data-prev="page2">戻る</button>
                            <button class="btn next" data-next="page4">次へ</button>
                        </div>
                    </section>
                    <!-- Page 4 -->
                    <section class="page" id="page4" aria-hidden="true">
                        <div class="balloon">
                            <p>@niftyからお得なお知らせメールを希望されますか？</p>
                        </div>
                        <div class="stack">
                            <button class="pick red">希望する</button>
                            <button class="pick blue">希望しない</button>
                        </div>
                        <div class="page-bottom">
                            <button class="btn back" data-prev="page3">戻る</button>
                            <button class="btn next" data-next="pageComplete">次へ</button>
                        </div>
                    </section>

                    <!-- 完了 -->
                    <section class="page" id="pageComplete" aria-hidden="true">
                        <div class="balloon">
                            <p>お申込みありがとうございました。受付が完了しました。</p>
                        </div>
                        <div class="page-bottom">
                            <button class="btn back" data-prev="page1">最初へ戻る</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        function fit() {
            const baseW = 768, baseH = 1024; // タブレット縦向き基準
            const w = window.innerWidth, h = window.innerHeight;
            const s = Math.min(w / baseW, h / baseH);

            const stage = document.getElementById('stage');
            const wrap = document.getElementById('stage-wrap');

            // スケーリング
            stage.style.transform = `scale(${s})`;
            stage.style.transformOrigin = 'top left';

            // ラッパを画面サイズにフィット
            wrap.style.width = `${w}px`;
            wrap.style.height = `${h}px`;

            // 中央寄せ（上下左右の余白を自動調整）
            stage.style.marginLeft = `${(w - baseW * s) / 2}px`;
            stage.style.marginTop = `${(h - baseH * s) / 2}px`;
        }

        addEventListener('resize', fit);
        fit();
    </script>
    <!-- three.js importmap -->
    <script type="importmap">
    {
      "imports": {
        "fflate": "https://cdn.jsdelivr.net/npm/fflate@0.7.4/esm/browser.js",
        "three": "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/",
        "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3/lib/three-vrm.module.min.js"
      }
    }
  </script>

    <script src="main.js" type="module"></script>

    <script>
        // ページごとのアニメ割当
        const ACTION_FOR_PAGE = {
            page1: 'idle',
            page2: 'yes',
            page3: 'no',
            page4: 'yes',
            pageComplete: 'idle',
        };

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => {
                const active = (p.id === id);
                p.classList.toggle('active', active);
                p.setAttribute('aria-hidden', !active);
            });
            // VRMアニメ再生
            const act = ACTION_FOR_PAGE[id] || 'idle';
            if (window.viewer?.playAction) window.viewer.playAction(act);
        }

        document.addEventListener('click', (e) => {
            const next = e.target.closest('[data-next]');
            const prev = e.target.closest('[data-prev]');
            if (next) showPage(next.dataset.next);
            if (prev) showPage(prev.dataset.prev);
        });

        // 初期表示
        showPage('page1');
    </script>
    <script>
        /* ==========================================================
           YouTube 再生（エラーに強い版）
           ========================================================== */
        let ytPlayer = null;
        let ytApiLoaded = false;

        function loadYouTubeAPI() {
            return new Promise((resolve) => {
                if (window.YT && window.YT.Player) { ytApiLoaded = true; resolve(); return; }
                const tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                window.onYouTubeIframeAPIReady = () => { ytApiLoaded = true; resolve(); };
                document.head.appendChild(tag);
            });
        }

        function showYTError(msg) {
            const box = document.getElementById('yt-error');
            if (!box) return;
            box.textContent = msg;
            box.hidden = false;
        }

        async function openYTModalAndPlay(videoId) {
            const modal = document.getElementById('yt-modal');
            modal.classList.add('active');
            showYTError(""); // 初期化
            const errBox = document.getElementById('yt-error'); if (errBox) errBox.hidden = true;

            await loadYouTubeAPI();

            const playerOptions = {
                playerVars: {
                    autoplay: 1,
                    rel: 0,
                    playsinline: 1,
                    modestbranding: 1
                },
                events: {
                    onReady: () => {
                        try { ytPlayer.loadVideoById(videoId); } catch (e) { showYTError("プレイヤー初期化に失敗しました。"); }
                    },
                    onStateChange: (e) => {
                        // 再生終了
                        if (e.data === YT.PlayerState.ENDED) {
                            closeYTModalAndGoNext();
                        }
                    },
                    onError: (e) => {
                        const map = {
                            2: "不正な動画IDです。",
                            5: "このブラウザで再生できません（HTML5プレイヤーエラー）。",
                            100: "動画が見つからないか、非公開です。",
                            101: "動画の埋め込みが許可されていません。",
                            150: "動画の埋め込みが許可されていません。"
                        };
                        showYTError(map[e.data] || "再生中にエラーが発生しました。");
                        console.error("YouTube error code:", e.data);
                    }
                }
            };

            if (!ytPlayer) {
                ytPlayer = new YT.Player('yt-player', playerOptions);
            } else {
                try { ytPlayer.loadVideoById(videoId); } catch (e) {
                    // プレイヤーが壊れていたら作り直し
                    ytPlayer.destroy?.();
                    ytPlayer = new YT.Player('yt-player', playerOptions);
                }
            }
        }

        function closeYTModalAndGoNext() {
            const modal = document.getElementById('yt-modal');
            modal.classList.remove('active');
            try { ytPlayer && ytPlayer.stopVideo(); } catch (e) { }
            showPage('page2');
        }

        // 視聴開始ボタンのクリックをフック
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-youtube]');
            if (!btn) return;
            e.preventDefault();  // すぐにページ遷移させない
            openYTModalAndPlay(btn.dataset.youtube);
        });
    </script>
</body>

</html>